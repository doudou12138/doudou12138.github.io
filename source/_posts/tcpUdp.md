---
title: tcp与udp
category: 网络
---
## 三次握手,四次挥手(TCP)
### 示意图
![tcp连接建立断开示意图](https://pic3.zhimg.com/80/v2-e8aaab48ff996e5cd8a5b39dc450bd6a_720w.webp)
tcp协议中内容,用于建立与断开连接.其中
- 三次握手用于建立连接,保证客户端与服务端各自的收发能力
- 四次挥手用于关闭连接,关闭双工连接
### 三次握手
- 三次握手为什么能保证双方各自的收发能力?

`第一次握手`: 客户端向服务端发送SYN,如果服务端成功接收到,则服务端能确定客户端的发送能力、自己(服务端)的接收能力
> 在服务端接收完成后会在**半连接队列**中为SYN包开设一个条目,标识该连接处于Syn_RECV状态

`第二次握手`: 服务端给客户端发送**Syn+Ack**,如果客户端接收到,则客户端能确定自己(客户端)的发送能力和接受能力,能确定服务端的发送能力和接受能力.此时客户端进入Established状态
`第三次握手`: 客户端给服务端发送**Ack**,如果服务端接收到,则服务端能确定客户端的接收能力和自己的发送能力,此时服务端进入Established状态
> 在第三次握手后服务端将从半连接队列删除本次连接,将本次连接加入**全连接队列**

### 四次挥手
![四次挥手示意图](https://pic3.zhimg.com/80/v2-629f51f6f535ebd7683f944707b21d1e_720w.webp)
TCP连接是双向传输的对等的模式，就是说双方都可以同时向对方发送或接收数据。当有一方要关闭连接时，会发送指令告知对方，我要关闭连接了。这时对方会回一个ACK，此时一个方向的连接关闭。但是另一个方向仍然可以继续传输数据，等到发送完了所有的数据后，会发送一个FIN段来关闭此方向上的连接。接收方发送ACK确认关闭连接。

- 一定是四次挥手嘛?
不一定.第二次挥手和第三次挥手可能合并,当服务端接收到第一次挥手的SYN后,如果服务端->客户端的方向上没有数据要发送时,第二次和第三次挥手可以合并为一次.

- 如果连接中,服务器挂了,客户端会断开连接吗
1. 当服务器挂了指的是进程崩溃时,内核会向客户端发送FIN,完成四次挥手
2. 当服务器挂了指的是服务器宕机时:
  - 如果客户端向服务器发送了请求,会失败,则会引起重试机制,当最远重试间隔达到某一阈值时,客户端会关闭连接
  - 如果客户端未向服务器发送请求,这时取决于客户端的**keepAlive**设置
  如果开启了keepAlive机制,客户端会定时向服务器发送检测报文,如果发现服务器掉线则断开连接
  如果没有开启keepAlive机制,就会保持连接直至发送请求
  
- 讲讲拥塞控制
拥塞控制是防止过多的数据进入到网络层,造成过负载.是针对全局而言的 
1. 慢开始算法  
cwnd从1开始逐渐翻倍,网络阻塞时重置为1  
2. 拥塞避免算法  
cwnd达到ssthresh后,cwnd的增长方式不再是翻倍,而是+1,当网络阻塞时就爱那个ssthresh/2,cwnd重置为1  
![](https://pic3.zhimg.com/80/v2-f7db63b1f00cbd8170e1435616e06216_720w.webp)
3. 快重传算法
当客户端发现没有接收到某个报文时,传回三个ACK,然后服务端马上重传丢失的报文而不用等待定时器超时
4. 快恢复算法
一般与快重传算法一起.当收到三个ACK后(说明网络情况没那么糟糕)
```
cwnd=cwnd/2
ssthresh = cwnd
```
即窗口和慢开始上限均变为窗口大小的一半

## TCP,UDP区别

1. Tcp面向连接,UDP无连接
2. TCP可靠,UDP不可靠
3. TCP具有重传机制(还有Ack机制),保证有序,Udp没有且无序
4. tcp对系统资源要求多,相对慢;udp更快
5. tcp有流量控制和拥塞控制的能力

- TCP,udp各自应用场景
TCP: web浏览,文件传输,邮件...
UDP: 视频与直播流媒体, 网络游戏...


- tcp是长连接还是短连接
tcp既有长连接,也有短连接  
> 短连接: 每次请求都会新建,断开连接;方便管理(连接的都是有用的)但是频繁地新建断开浪费cpu资源
长连接: 请求完可以不断开连接;不方便管理(连接的都是有用的)但无需频繁地新建断开